<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Chat built in thorio in 1h </title>
    <style>
        input {
            display: inline;
        }

        #nick-name {
            width: 150px;
        }

        #chat-message {
            width: 60%;
        }

        .is-private {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Chat</h1>
    <p>
        Target a specific user by adding @ to the username i.e @foo will just send the message to that particular user.   
    </p>
    <p>
        Gist ( code ) can be <a href="https://gist.github.com/MagnusThor/5ae998040b2a76752de864acc9dd077d">found on here</a> more info about thor-io at <a href="https://github.com/MagnusThor/thorio/wiki">https://github.com/MagnusThor/thorio/wiki</a>
    </p>
    <hr>
    <div>
        <input type="text" id="nick-name" placeholder="" />
        <input type="text" id="chat-message" placeholder="enter a message" />
    </div>
    <hr />
    <div id="messages"></div>
    <script src="//rawgit.com/MagnusThor/thorio.client/master/src/thorio.client.latest.js">
    </script>
    <script>
        var client;
        var $ = function (q, el) {
            if (!el) el = document;
            return el.querySelector(q);
        };

        var addMessage = function (message) {

            var p = document.createElement("p");
            var dt = message.dt ? new Date(message.dt) : new Date();
            var nickName = message.n ? message.n : "Unknown"
            p.textContent = dt.getHours() + ":" + dt.getMinutes() + " (" + nickName + " ) -  " + message.t;

            if (message.hasOwnProperty("p")) p.classList.add("is-private");

            $("#messages").insertBefore(p, $("#messages").firstChild);
        };

        document.addEventListener("DOMContentLoaded", function () {
            var client = new ThorIOClient.Factory("ws://thorio.azurewebsites.net/", ["chat"]);

            client.onopen = function (chat) {

                addMessage({
                    t: "Connected to the Engine (endpoint)",
                })
                chat.onopen = function (ci) {
                    addMessage({
                        t: "Connected to the chat, getting history.",
                    });

                    this.invoke("getHistory", {});

                };

                chat.on("nickname", function (message) {
                    addMessage(message);
                    $("#nick-name").value = message.n;
                });

                chat.on("chatmessage", function (message) {
                    addMessage(message);
                });
                chat.on("history", function (messages) {
                    messages.forEach(function (message) {
                        addMessage(message);
                    });
                });

                document.querySelector("#chat-message").addEventListener("keydown", function (evt) {
                    if (evt.keyCode === 13) {
                        chat.invoke("sendMessage",
                            { t: evt.target.value, dt: new Date() });
                        evt.target.value = "";
                    };
                });
                document.querySelector("#nick-name").addEventListener("keydown", function (evt) {
                    if (evt.keyCode === 13) {
                        chat.invoke("setNickname",
                            { nickname: evt.target.value });

                    };
                });

                chat.connect();
            };
        });
    </script>
</body>
</html>